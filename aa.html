<!DOCTYPE html>
<html>

<head>
    <title>TODO supply a title</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
        .contenedor {
            width: 350px;
            float: left;
        }

        .titulo {
            font-size: 12pt;
            font-weight: bold;
        }

        #camara,
        #foto,
        #miim,
        #miimleer {
            width: 320px;
            min-height: 240px;
            border: 1px solid #306430;
        }
    </style>
</head>

<body>
    <div id='botonera'>
        <input id='botonIniciar' type='button' value='Iniciar'></input>
        <input id='botonDetener' type='button' value='Detener'></input>
        <input id='botonFoto' type='button' value='Foto'></input>
    </div>
    <div class="contenedor">
        <div class="titulo">Cámara</div>
        <video id="camara" autoplay controls></video>
    </div>
    <div class="contenedor">
        <div class="titulo">Foto</div>
        <canvas id="foto"></canvas>
    </div>

    <img id="miimleer" onclick="leer()" />
    <input type="text" id="numero" value="1" />
</body>
<script>
    window.URL = window.URL || window.webkitURL;
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia ||
        function () {
            alert('Su navegador no soporta navigator.getUserMedia().');
        };

    //Este objeto guardará algunos datos sobre la cámara
    window.datosVideo = {
        'StreamVideo': null,
        'url': null
    }



    function iniciar() {

        //Pedimos al navegador que nos da acceso a 
        //algún dispositivo de video (la webcam)
        navigator.getUserMedia({
            'audio': false,
            'video': true
        }, function (streamVideo) {
            datosVideo.StreamVideo = streamVideo;
            datosVideo.url = window.URL.createObjectURL(streamVideo);
            var micamara = document.querySelector('#camara');
            micamara.src = datosVideo.url;
            //   micamara.attr('src', datosVideo.url);



        }, function () {
            alert('No fue posible obtener acceso a la cámara.');
        });

    }



    function detener() {

        if (datosVideo.StreamVideo) {
            datosVideo.StreamVideo.stop();
            window.URL.revokeObjectURL(datosVideo.url);
        }

    }
    ;



    function foto() {

        var oCamara, oFoto, oContexto, w, h;
        /*
         oCamara = document.querySelector('#camara');
         oFoto = document.querySelector('#foto');
         w =100; //oCamara.width();
         h = 50;//oCamara.height();
         oFoto.width=w;
         oFoto.height=h;
         
         oContexto = oFoto.getContext('2d');
         
         oContexto.drawImage(oCamara , 0, 0, w, h);
         
         */
        startDB();


    }
    var porIniciar = document.querySelector("#botonIniciar");
    var porDetener = document.querySelector("#botonDetener");
    var porFoto = document.querySelector("#botonFoto");
    porIniciar.onclick = iniciar;
    // porIniciar.addActionListener('click', iniciar, false);
    porDetener.onclick = detener;
    // porDetener.addActionListener('click', detener, false);
    porFoto.onclick = foto;
    // porFoto.addActionListener('click', foto, false);


    function startDB() {
        dataBaseC = indexedDB.deleteDatabase("imagenes", 1);
        dataBase = indexedDB.open("imagenes", 1);
        // Creamos  o abrimos la base de datos con un numero de version
        // Es importante el significado de la  versión(1), pero aún no no tengo claro.
        dataBase.onupgradeneeded = function (e) {
            // El método   onupgradeneeded se ejecuta la primera vez que se crea la base de datos  
            // El método createObjectStore solo se puede utilizar dentro de esta function
            // Si cambiamos de versión tambien se dispara onupgradeneeded
            // Como hemos dicho  Ese evento también se dispará la primera vez que se abre la BD y 
            // ahí es donde se deben crear tablas e índices.
            orden = dataBase.result;
            // onden es un objeto que nos permite ejecutar acciones contra la base de datos creada, como crear un tabla
            var tabla = orden.createObjectStore("galeria", { keyPath: 'id', autoIncrement: true });
            //  createObjectStore crea una tabla, el campo clave obligatorio por medio de KeyPath y si el indice es autoincremento                  

            // Creamos cuanto indices necesitemos para despues realizar búsquedas. Se crea un indice por cada campo de la tabla 
            // que vayamos a necesitar
            alert('Base de datos creada');
        };

        dataBase.onsuccess = function (e) {
            // Este evento se ejecuta si la creación o apertura de la base de datos es correcta   
            // Ya podemos emprexar a grabar, borrar o buscar registros en la base de datos
            alert('Base de datos cargada');
            // En este evento realizaremos una lectura secuencial de la bae de datos cmo despues se explica.                  
            var orden = dataBase.result;
            // Crea un objeto para ejecutar ordenes contra la base de datos               
            var transacion = orden.transaction(["galeria"], "readwrite");
            // Crea una transación sobre una  tabla de la base de datos para lectura y escritura
            var tabla = transacion.objectStore("galeria");
            // Crea un objeto para realizar la transaccion sobre la tabla . En este caso un méto put
            // que graba un registro. Devuelve un objeto request que se utiliza para ejecutar un método asíncrono
            // que permite evaluar si ha tenido exito o no la transacción.
            // El método put graba si no existe un regisrtro con la clave indicada o lo sobreescribe(modifica)
            //  si existe.
            oCamara = document.querySelector('#camara');
            oFoto = document.querySelector('#foto');
            w = 100; //oCamara.width();
            h = 50;//oCamara.height();
            oFoto.width = w;
            oFoto.height = h;
            /* oFoto.attr({
             'width': w,
             'height': h
             });*/

            //  oContexto = oFoto[0].getContext('2d');
            oContexto = oFoto.getContext('2d');

            oContexto.drawImage(oCamara, 0, 0, w, h);


            var myImage = oFoto.toDataURL("image/png");
            var imageElement = document.getElementById("miim");
            // Set the src to data from the canvas 
            imageElement.src = myImage;


            var request = tabla.put({
                "Nombreimagen": "Nombre",
                "imagen": myImage
            });

        };

        dataBase.onerror = function (e) {
            // Si se produce un error se ejecuta este método. Ocurre cuando cambiamos de versión
            alert('Error cargandoo la base de datos ' + e.target);
        };

    }

    function leer() {
        alert("Leer");
        var orden = dataBase.result;
        var transacion = orden.transaction(["galeria"], "readonly");
        var tabla = transacion.objectStore("galeria");
        var imagendestiono = document.getElementById("miimleer");

        // Lerr por la clave principal isbn

        var n = parseInt(numero.value);
        alert(n);
        var request = tabla.get(n);
        request.onsuccess = function () {
            var result = request.result;
            if (result !== undefined) {
                alert("ID: " + result.id);
                alert(result.imagen);
                //   var jsonStr = JSON.stringify(result.imagen);

                //   alert(datos);
                //     alert(jsonStr);
                imagendestiono.src = result.imagen;



            }
            ;
        }


    }
</script>

</html>